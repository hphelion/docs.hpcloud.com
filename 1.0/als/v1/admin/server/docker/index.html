<!doctype html>
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if IE 9]>    <html class="no-js ie9" lang="en"> <![endif]-->
<!--[if gt IE 9]><!--> <html class="no-js" lang="en"> <!--<![endif]-->

<!-- Mirrored from docs.hpcloud.com/als/v1/admin/server/docker/ by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 20 Feb 2015 14:59:50 GMT -->
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>Docker & Fence</title>
	
	
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link rel="shortcut icon" href="../../../../../favicon.ico" type="image/vnd.microsoft.icon" />
  <link rel="stylesheet" href="../../../../../css/combined.css">

	<script src="../../../../../js/modernizr-2.5.3.min.js"></script>
	<script src="../../../../../js/metrics.js"></script> 
</head>
<body>
  <div id="wrapper">
    <!--[if lt IE 7]>
    	<p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
    <![endif]-->
    <div class="header-container">
      <header class="header">
      	<div class="top-bar" style="height: 75px;">
		
      		<div class="search-wrapper wrapper container_16">
			
      			<a href="#" class="sales-rep show-320 show-480 hide-768"><span aria-hidden="true" class="icon-icon-sales-rep"></span></a>
      			<nav class="sub-nav" >
				<a href="../../../../../index.html" class="logo"  ><img src="../../../../../images/HP_Helion_logo_72.png" style="position: absolute;top: 10px;" alt="HP Helion" /></a>
        			<ul>
					
 

         
        				<li><a href="../../../../../../external.html?link=http://www8.hp.com/us/en/cloud/helion-portfolio.html">Helion@HP</a></li>
						<li><a href="../../../../../../external.html?link=https://h30580.www3.hp.com/">Support</a></li>
        				<li><a href="mailto:heliondocs@hp.com">Contact</a></li>
						
        				 
        			</ul>
      			</nav>
          </div>
      	</div>
		<!-- per JC
      	<div class="nav-wrapper wrapper container_16">
        	<a href="http://www.hpcloud.com/" class="logo"><img src="/images/HP_Helion_logo_72.png" alt="HP Helion" /></a>
      		<nav class="nav hide-320 show-768">
      			<ul>
      				<li><a href="http://hpcloud.com/products-services">Products <span>& Services</span></a></li>
      				<li><a href="http://hpcloud.com/solutions">Cloud <span>Solutions</span></a></li>
      				<li><a href="http://hpcloud.com/why-hp-cloud">Why HP <span>Cloud?</span></a></li>
      				<li><a href="http://hpcloud.com/learning-center">Learning <span>Center</span></a></li>
      				<li><a href="http://hpcloud.com/blog">The <span>Blog</span></a></li>
      				<li><a href="http://hpcloud.com/free-trial">Sign Up <span>Today</span></a></li>
      			</ul>
      		</nav>
      	</div>
		-->
      </header>
    </div>
		<div id="main-container">
			<div id="main" class="wrapper clearfix container_16">
				<div id="content" class="grid_10 suffix_1">
	<article>
		<!--PUBLISHED-->

<h1 id="-hp-helion-10-development-platform-docker--fence"># HP Helion 1.0 Development Platform: Docker &amp; Fence<a href="#docker-fence" title="Permalink to this headline"></a></h1>

<p>Application Lifecycle Service's <a href="../../reference/architecture/index.html#architecture-dea"><em>DEA role</em></a>
runs Linux containers to isolate user applications during staging and at
runtime. Management of these application containers is handled by the
<code>fence</code> process, which in turn uses
<a href="../../../../../../external.html?link=http://docs.docker.io/en/latest/">Docker</a> to create and destroy Linux
containers on demand.</p>

<p>Typically, admins will not have to work directly Docker, but it is
available if needed to customize or create new container images.</p>

<h2 id="modifying-or-updating-the-container-image">Modifying or Updating the Container Image<a href="#modifying-or-updating-the-container-image" title="Permalink to this headline"></a></h2>

<p>Application containers are created from a base Docker image (a template
used to create Linux containers). Admins can create new images to add
specific software required by applications or update operating system
packages.</p>

<p>To create a new base image for Application Lifecycle Service to use for application
containers, perform the following steps <strong>on all nodes running the DEA
role</strong>:</p>

<ol><li><p>Start with an empty working directory:</p>

<pre><code>$ mkdir ~/newimg
$ cd ~/newimg
</code></pre></li>
<li><p>Check which image Application Lifecycle Service is currently using as an app container
template:</p>

<pre><code>$ kato config get fence docker/image
helion/stack/alsek
</code></pre></li>
<li><p>Create a <a href="../../../../../../external.html?link=http://docs.docker.io/en/latest/use/builder/">Dockerfile</a>
which inherits the current Docker image, then runs an update or
installation command. For example:</p>

<pre><code>FROM helion/stack/alsek
RUN apt-get -y install libgraphite2-dev
</code></pre>

<ul><li><a href="../../../../../../external.html?link=http://docs.docker.io/en/latest/use/builder/#from">FROM</a>:
inherits the environment and installed software from Application Lifecycle Service's
app image.</li>
<li><a href="../../../../../../external.html?link=http://docs.docker.io/en/latest/use/builder/#run">RUN</a>:
specifies arbitrary commands to run before saving the image.</li>
<li><a href="../../../../../../external.html?link=http://docs.docker.io/en/latest/use/builder/#add">ADD</a>: could
be used to copy files into the image.</li>
</ul></li>
<li><p>Build the image, setting the maintainer's name, and an image name:</p>

<pre><code>$ sudo docker build -rm -t exampleco/newimg .
</code></pre></li>
<li><p>Configure Application Lifecycle Service to use the new image:</p></li>
</ol><p>
  <strong>Note</strong>
</p>

<p>This step only needs to be done once, as the configuration change is
shared with all nodes:</p>

<pre>
  <code>$ kato config set fence docker/image exampleco/newimg
WARNING: Assumed type string
exampleco/newimg
</code>
</pre>

<h2 id="admin-hooks">Admin Hooks<a href="#admin-hooks" title="Permalink to this headline"></a></h2>

<p>If an administrator wants to run arbitrary commands in all application
containers, global admin hooks can be set to run immediately after
corresponding user-specified deployment hooks (pre-staging,
post-staging, pre-running) set in application 
<a href="../../../user/deploy/manifestyml/index.html">manifest.yml</a> files.</p>

<p>These hooks must be:</p>

<ul><li>plain bash scripts with the executable bit set (<code>chmod +x</code>)</li>
<li>named <em>pre-staging</em>, <em>post-staging</em>, or <em>pre-running</em></li>
<li>installed in <em>/etc/helion/hooks</em> within the Docker image</li>
</ul><p>For example, a pre-running admin hook might look like this:</p>

<pre>
  <code>#!/bin/sh
export PRE_RUN_DATE=`date`
export EXAMPLECO_KEY="3A0fwPwUftDu0FEzmhN8yJkvM1vS6A"
if [ -z "$NEW_RELIC_LICENSE_KEY" ]; then
  echo "setting default New Relic key"
  export NEW_RELIC_LICENSE_KEY="bdb9b44e8n4411d8bf39870f1919927d79cr0f1r"
fi
export HELION_HOOK_ENV=PRE_RUN_DATE,EXAMPLECO_KEY
sudo /usr/sbin/nrsysmond-config --set license_key=$NEW_RELIC_LICENSE_KEY
sudo /etc/init.d/newrelic-sysmond start
</code>
</pre>

<p>
  <strong>Note</strong>
</p>

<p>The <code>HELION_HOOK_ENV</code> environment variable is
needed to expose the specified variables in <code>helion ssh</code> sessions, the application container's crontab, and PHP
applications using the Legacy buildpack. This requirement may change in
subsequent releases.</p>

<p>The Dockerfile for creating the image (see <a href="#docker-modify-container"><em>Modifying or Updating the
Container Image</em></a> ) would use the ADD
directive to put a local <em>hooks</em> directory in the Docker image's
<em>/etc/helion/</em> directory:</p>

<pre>
  <code>FROM helion/stack/alsek
ADD hooks /etc/helion/hooks
</code>
</pre>

<p>The pre-running hook example above would require the addition of
<code>newrelic-sysmond</code> to the Docker image. A Dockerfile
enabling that might look like this:</p>

<pre>
  <code>FROM helion/stack/alsek

RUN echo deb http://apt.newrelic.com/debian/ newrelic non-free &gt;&gt; /etc/apt/sources.list.d/newrelic.list
RUN wget -O- https://download.newrelic.com/548C16BF.gpg | apt-key add -
RUN apt-get update
RUN apt-get install newrelic-sysmond
# The nrsysmond scripts are run with sudo
RUN echo "HELION ALL= NOPASSWD: /etc/init.d/newrelic-sysmond" &gt;&gt; /etc/sudoers
RUN echo "HELION ALL= NOPASSWD: /usr/sbin/nrsysmond-config" &gt;&gt; /etc/sudoers

ADD hooks /etc/helion/hooks
</code>
</pre>

<h2 id="creating-a-docker-registry">Creating a Docker Registry<a href="#creating-a-docker-registry" title="Permalink to this headline"></a></h2>

<p>The steps above will work with smaller clusters or micro clouds where
the creation of Docker images on each DEA can be done manually. On
larger clusters, you should set up a <a href="../../../../../../external.html?link=http://blog.docker.io/2013/07/how-to-use-your-own-registry/">Docker
registry</a>
as a central repository for your container templates.</p>

<ol><li><p>On the Core node of your cluster, pull the docker-registry
\&lt;https://index.docker.io/u/samalba/docker-registry/&gt; image from
the Docker index:</p>

<pre><code>$ sudo docker pull helion/docker-registry
</code></pre></li>
<li><p>Start the server:</p>

<pre><code>$ sudo docker run -d -p 5000 helion/docker-registry
f39d1b3f6fedc50e77875526352bd5a0f650a998dc1d7ca4e39c4a1eb8349e42
</code></pre>

<p>This returns the ID of the running registry server image. A shorter
container ID is also available via <code>docker ps</code>.
You can use either for the subsequent commands.</p></li>
<li><p>Use the ID to get the public facing port for the running image. For
example:</p>

<pre><code>$ sudo docker port f39d1b3f6fed 5000
0.0.0.0:49156
</code></pre>

<p>Your registry location is a combination of the API endpoint of your
cluster (i.e. <code>kato config get cluster endpoint</code>) combined with the port number returned by the command
above. For example:</p>

<pre><code>api.paas.example.com:49156
</code></pre>

<p>This registry location will be used to pull the images you create to
your DEA nodes.</p></li>
<li><p>Go through steps 1 - 3 <a href="#docker-modify-container"><em>above</em></a> to create
a Docker image file. When building the image, substitute the
registry location for the organization name used in step 4. For
example:</p>

<pre><code>$ sudo docker build -rm -t api.paas.example.com:49156/exampleco/newimg .
</code></pre></li>
<li><p>Push the newly built Docker image to the registry:</p>

<pre><code>$ sudo docker push api.paas.example.com:49156/exampleco/newimg
</code></pre></li>
</ol><blockquote>
  <p>Note</p>
  
  <p>The helion/stack/alsek and helion/base images (approximately
  1.9GB) are pushed to the registry in addition to the new image. Make
  sure you have sufficient disk space available on the VM.</p>
</blockquote>

<ol><li><p><strong>On all DEA nodes</strong>, pull the new image from the registry:</p>

<pre><code>$ sudo docker pull api.paas.example.com:49156/exampleco/newimg
</code></pre></li>
<li><p>Configure Application Lifecycle Service to use the new image:</p>

<pre><code>$ kato config set fence docker/image api.paas.example.com:49156/exampleco/newimg
WARNING: Assumed type string
api.paas.example.com:49156/exampleco/newimg
</code></pre>

<p>This step only needs to be done once, as the configuration change is
shared with all nodes</p></li>
</ol><h3 id="table-of-contents">
  <a href="../../../index-2/index.html">Table Of Contents</a>
</h3>

<ul><li><a href="#">Docker &amp; Fence</a>

<ul><li><a href="#modifying-or-updating-the-container-image">Modifying or Updating the Container
Image</a></li>
<li><a href="#admin-hooks">Admin Hooks</a></li>
<li><a href="#creating-a-docker-registry">Creating a Docker Registry</a></li>
</ul></li>
</ul>
	</article>
</div>

<div id="sidebar" class="grid_5 top-spacer">
	<aside class="signup-box">
		<p class="align-center">
			Download the<br>Development Platform<br>
			<a href="../../../../../../external.html?link=https://helion.hpwsportal.com/#/Home/Show">DOWNLOAD NOW</a>
		</p>
	</aside>
	
 
	<aside class="signup-box">
		<p class="align-center">
			Take the Helion Development Platform for a Free Spin<br>
			<a href="../../../../../helion/devplatform/ALS-developer-trial-quick-start/index.html">Quick Start Developer Trial</a>
		</p>
	</aside>
<!--	
	<aside class="signup-box">
		<p class="align-center">Make sure to check out our Developer Portal
			<a href="https://dev.hpcloud.com">dev.hpcloud.com
</a><br>
 
		</p>
	</aside>
-->	
	<aside class="box section-navigation">
  
     
  
  <ul>
    
      
      
      <li>
        <a class="" href="../../../../../index.html"><span>HP Helion Documentation</span></a>
      </li>
    
      
      
      <li>
        <a class="" href="../../../../../helion/devplatform/index.html"><span>HP Helion Development Platform Documentation Home</span></a>
      </li>
    
      
      
      <li>
        <a class="" href="../../../../../helion/devplatform/install/index.html"><span>Development Platform Installation & Configuration</span></a>
      </li>
    
      
      
      <li>
        <a class="" href="../../../../../helion/devplatform/install/community/index.html"><span>Development Platform Community Edition Installation & Configuration</span></a>
      </li>
    
      
      
      <li>
        <a class="" href="../../../../../helion/openstack/update/devplat/101/index.html"><span>Development Platform Commercial 1.0.1 Update</span></a>
      </li>
    
      
      
      <li>
        <a class="" href="../../../../../helion/devplatform/appdev/index.html"><span>Application Developer Resources</span></a>
      </li>
    
      
      
      <li>
        <a class="" href="../../../../../helion/devplatform/sysadmin/index.html"><span>IT Ops Resources</span></a>
      </li>
    
      
      
      <li>
        <a class="" href="../../../../../helion/devplatform/appdev/index.html#sample"><span>Sample Code</span></a>
      </li>
    
      
      
      <li>
        <a class="" href="../../../../../helion/devplatform/release-notes/index.html"><span>Release Notes</span></a>
      </li>
    
      
      
      <li>
        <a class="" href="../../../../../helion/devplatform/related-topics/index.html"><span>Related Documentation</span></a>
      </li>
    
      
      
      <li>
        <a class="" href="../../../../../helion/devplatform/deploy/index.html"><span>Application Lifecycle Service Configuration and Deployment</span></a>
      </li>
    
      
      
      <li>
        <a class="" href="../../index.html"><span>ALS Admin Guide</span></a>
      </li>
    
      
      
      <li>
        <a class="" href="../../../../../helion/devplatform/eula/index.html"><span>End User License Agreement</span></a>
      </li>
    
      
      
      <li>
        <a class="" href="../../../../../helion/devplatform/3rd-party-license-agreements/index.html"><span>Open Source and Third-Party Software License Agreements</span></a>
      </li>
    
  </ul>
</aside>
</div>

			</div> <!-- #main -->
		</div> <!-- #main-container -->
	</div> <!-- #wrapper -->

		
  <footer class="footer">
    <div class="container_16">
    	<div class="wrapper grid_16">
    		<ul class="footer-social">
    			<li class="twitter"><a href="../../../../../../external.html?link=https://twitter.com/hphelioncloud"></a></li>
    			<li class="youtube"><a href="../../../../../../external.html?link=http://www.youtube.com/hpcloud"></a></li>
    			<li class="rss"><a href="../../../../../../external.html?link=http://h30499.www3.hp.com/hpeb/rss/board?board.id=sws-661"></a></li>
    			<li class="facebook"><a href="../../../../../../external.html?link=https://www.facebook.com/HPCloud"></a></li>
    			<li class="linkedin stretch"><a href="../../../../../../external.html?link=https://www.linkedin.com/company/hewlett-packard"></a></li>
    		</ul>
    		<ul class="contact-info">
    			<li>In the U.S.<br />1-855-61CLOUD</li>
    			<li>Worldwide<br />+1678-745-9010</li>
    			<li class="col-3">Online Support<br /><a href="mailto:support@hpcloud.com">Email</a> 
				<!-- comment out per JC
				or <span class="link" onclick="jQuery('#hpcloud-chat-button a').click();">Chat with us</span>
				-->
				</li>
    		</ul>
    		<div class="copyright">
    			<p>The OpenStack&reg; Word Mark and OpenStack Logo are either registered trademarks/service marks or trademarks/service marks of the OpenStack Foundation, in the United States and other countries and are used with the OpenStack Foundation's permission. We are not affiliated with, endorsed or sponsored by the OpenStack Foundation, or the OpenStack community.</p><br />
    			<p>&copy; 2014 Hewlett-Packard Development Company, L.P.<br /><a href="../../../../../../external.html?link=http://www.hpcloud.com/legal-documents">HP Cloud legal documents and privacy policy</a></p>
    		</div>
    	</div>
    </div>
  </footer>

	<script src="../../../../../../ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script src="../../../../../../ajax.googleapis.com/ajax/libs/jqueryui/1.10.2/jquery-ui.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../../../../js/jquery-1.8.2f.min.html"><\/script>')</script>

  <script src="../../../../../js/combined.js"></script>
  <script>
      __HP_CHAT_CONF = {};
      __HP_CHAT_CONF.sales = true;
      __HP_CHAT_CONF.support = true;
    </script>
	
    <script> //removed per JC
    //(function($, window) {
    //    $(window).load(function() {
    //    var sNew = document.createElement("script");
    //  sNew.async = true;
    //sNew.src = 'https://a248.e.akamai.net/cdn.hpcloudsvc.com/gcbb18d905d32174e6eb205943b0dea4a/prodae1/chat.js';
    //var s0 = document.getElementsByTagName('script')[0];
    //s0.parentNode.insertBefore(sNew, s0);
    //});
    //})(jQuery, this);
    </script>
    <script>
        //Executes your code when the DOM is ready.  Acts the same as $(document).ready().
        function styleRestCmds() {
            $("h5:contains('GET')").addClass('rest_cmd cmd_get');
            $("h5:contains('POST')").addClass('rest_cmd cmd_post');
            $("h5:contains('FormPOST')").removeClass('rest_cmd cmd_post');
            $("h5:contains('PUT')").addClass('rest_cmd cmd_put');
            $("h5:contains('COPY')").addClass('rest_cmd cmd_copy');
            $("h5:contains('PATCH')").addClass('rest_cmd cmd_patch');
            $("h5:contains('HEAD')").addClass('rest_cmd cmd_head');
            $("h5:contains('DELETE')").addClass('rest_cmd cmd_delete');
        }

        $(function() {
            //Calls the tocify method on your HTML div.
            $("#toc").tocify({
                'selectors': 'h2,h3,h4',
                'showAndHideOnScroll': false,
                'hideEffect': 'slideUp',
                'scrollTo': 55    // Amount of space between top of page and selected content
              }
            );
            // Style the REST commands
            styleRestCmds();
        });
    </script>
</body>

<!-- Mirrored from docs.hpcloud.com/als/v1/admin/server/docker/ by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 20 Feb 2015 14:59:50 GMT -->
</html>
